<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!--
    ╔══════════════════════════════════════════════════════════════╗
    ║  BUG FIX #2 — iOS KEYBOARD / VIEWPORT                       ║
    ║  We do NOT use maximum-scale=1.0 anymore because iOS uses it ║
    ║  to suppress viewport resize events from the soft keyboard.  ║
    ║  The interactive-widget=resizes-content meta makes modern    ║
    ║  Chrome/Android respect the visual viewport. On iOS we use   ║
    ║  window.visualViewport resize JS instead (see bottom).       ║
    ╚══════════════════════════════════════════════════════════════╝
  -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, interactive-widget=resizes-content" />
  <title>Relay — Messenger</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Emoji Picker Web Component (zero-dependency, ~50kb) -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Fraunces:ital,wght@0,300;0,600;1,300&display=swap" rel="stylesheet" />

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { display:['Fraunces','serif'], mono:['DM Mono','monospace'] },
          colors: { ink:'#0d0d0d', paper:'#f5f0e8', cream:'#ede8dc', rust:'#c84b31', sage:'#5a7a5e', mist:'#8a9ba8', amber:'#d4a027' },
          keyframes: {
            'slide-up':  { '0%':{ opacity:'0', transform:'translateY(8px)' }, '100%':{ opacity:'1', transform:'translateY(0)' } },
            'fade-in':   { '0%':{ opacity:'0' }, '100%':{ opacity:'1' } },
            'pulse-dot': { '0%,100%':{ opacity:'1' }, '50%':{ opacity:'0.3' } },
            'recording': { '0%,100%':{ transform:'scale(1)' }, '50%':{ transform:'scale(1.2)' } },
            'badge-pop': { '0%':{ transform:'scale(0)' }, '70%':{ transform:'scale(1.2)' }, '100%':{ transform:'scale(1)' } },
          },
          animation: {
            'slide-up':  'slide-up 0.2s ease-out forwards',
            'fade-in':   'fade-in 0.3s ease-out forwards',
            'pulse-dot': 'pulse-dot 1.4s ease-in-out infinite',
            'recording': 'recording 1s ease-in-out infinite',
            'badge-pop': 'badge-pop 0.25s cubic-bezier(.4,2,.6,1) forwards',
          },
        },
      },
    };
  </script>

  <style>
    /* ─────────────────────────────────────────────────
       BASE RESET & TYPOGRAPHY
    ───────────────────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; }
    html { height: 100%; }

    /*
      BUG FIX #2 (iOS): We use min-height:100% instead of height:100%
      on body, and let #app be positioned via JS on keyboard open.
      overflow:hidden on body prevents iOS bounce scroll that pushes
      content behind the keyboard.
    */
    body {
      min-height: 100%;
      height: 100%;
      margin: 0;
      overflow: hidden;
      font-family: 'DM Mono', monospace;
      background: #f5f0e8;
      /* Prevent iOS text size adjust on rotation */
      -webkit-text-size-adjust: 100%;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
    .spin { animation: spin 0.7s linear infinite; }

    /* Paper grain overlay */
    body::before {
      content: ''; position: fixed; inset: 0;
      pointer-events: none; z-index: 9999; opacity: 0.22;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.05'/%3E%3C/svg%3E");
    }

    /* ─────────────────────────────────────────────────
       APP LAYOUT
       BUG FIX #2: Use dvh (dynamic viewport height) with
       vh fallback. dvh shrinks when iOS keyboard appears.
    ───────────────────────────────────────────────── */
    #app {
      display: flex;
      height: 100dvh;      /* dynamic viewport — shrinks with keyboard on modern browsers */
      height: 100vh;       /* fallback for older browsers (overridden by dvh above) */
      position: relative;
      z-index: 10;
      transition: height 0.12s ease-out; /* smooth on Android */
    }

    /* ─────────────────────────────────────────────────
       SIDEBAR
    ───────────────────────────────────────────────── */
    #sidebar {
      width: 300px; flex-shrink: 0;
      background: #ede8dc;
      border-right: 1px solid rgba(13,13,13,0.1);
      display: flex; flex-direction: column;
      transition: transform 0.28s cubic-bezier(.4,0,.2,1);
    }
    #conv-list { flex: 1; overflow-y: auto; }
    #conv-list::-webkit-scrollbar { width: 2px; }
    #conv-list::-webkit-scrollbar-thumb { background: #c8c0b0; }

    /* ─────────────────────────────────────────────────
       CHAT PANEL
    ───────────────────────────────────────────────── */
    #chat-panel { flex: 1; display: flex; flex-direction: column; min-width: 0; overflow: hidden; }

    #chat-messages {
      flex: 1 1 0%;
      overflow-y: auto;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
      /* BUG FIX #2: Give messages room to breathe above input bar */
      padding-bottom: 8px;
    }
    #chat-messages::-webkit-scrollbar { width: 3px; }
    #chat-messages::-webkit-scrollbar-thumb { background: #c8c0b0; border-radius: 2px; }

    /* ─────────────────────────────────────────────────
       INPUT BAR
       BUG FIX #2: We do NOT use position:fixed here.
       Fixed elements detach from the scroll container
       on iOS, causing them to sit behind the keyboard.
       Instead, the bar stays in normal flow as a
       flex-shrink:0 child, which iOS respects.
    ───────────────────────────────────────────────── */
    #input-area {
      flex-shrink: 0;
      background: rgba(245,240,232,0.97);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-top: 1px solid rgba(13,13,13,0.08);
      /* Safe area inset for iPhone notch/home bar */
      padding-bottom: max(12px, env(safe-area-inset-bottom));
      padding-top: 10px;
      padding-left: 12px;
      padding-right: 12px;
    }

    /* ─────────────────────────────────────────────────
       CONVERSATION ITEMS
    ───────────────────────────────────────────────── */
    .conv-item { cursor: pointer; transition: background 0.15s; position: relative; }
    .conv-item:hover  { background: rgba(13,13,13,0.05); }
    .conv-item.active { background: rgba(200,75,49,0.1); }
    .conv-item.blocked-item { opacity: 0.45; }

    /* Unread badge */
    .unread-badge {
      position: absolute; right: 14px; top: 50%; transform: translateY(-50%);
      min-width: 18px; height: 18px; padding: 0 5px;
      background: #c84b31; color: #f5f0e8;
      border-radius: 9px; font-size: .6rem; font-weight: 500;
      display: flex; align-items: center; justify-content: center;
      animation: badge-pop 0.25s cubic-bezier(.4,2,.6,1) forwards;
    }

    /* ─────────────────────────────────────────────────
       PRESENCE INDICATORS
    ───────────────────────────────────────────────── */
    .presence-dot {
      width: 9px; height: 9px; border-radius: 50%;
      border: 1.5px solid #ede8dc; flex-shrink: 0;
    }
    .presence-dot.online  { background: #5a7a5e; }
    .presence-dot.offline { background: transparent; border-color: #8a9ba8; }

    /* ─────────────────────────────────────────────────
       MESSAGE BUBBLES
    ───────────────────────────────────────────────── */
    .msg-bubble { animation: slide-up 0.18s ease-out; }

    /* ─────────────────────────────────────────────────
       VOICE RECORDER
    ───────────────────────────────────────────────── */
    .voice-bar { display: none; align-items: center; gap: 8px; }
    .voice-bar.active { display: flex; }
    .rec-pulse { animation: recording 1s ease-in-out infinite; }

    audio { height: 28px; max-width: 180px; min-width: 100px; }
    audio::-webkit-media-controls-panel { background: transparent; }

    /* Waveform bars */
    .wave-bar { width: 3px; border-radius: 3px; background: #8a9ba8; animation: wave-anim 0.8s ease-in-out infinite; }
    @keyframes wave-anim { 0%,100%{ transform:scaleY(0.4); } 50%{ transform:scaleY(1.3); } }
    .wave-bar:nth-child(2){ animation-delay:.1s; }
    .wave-bar:nth-child(3){ animation-delay:.2s; }
    .wave-bar:nth-child(4){ animation-delay:.3s; }
    .wave-bar:nth-child(5){ animation-delay:.15s; }

    /* ─────────────────────────────────────────────────
       IMAGE PREVIEW (upload)
    ───────────────────────────────────────────────── */
    #img-preview-bar { display: none; }
    #img-preview-bar.active { display: flex; }
    #img-preview-thumb { max-height: 64px; max-width: 80px; border-radius: 8px; object-fit: cover; }

    /* ─────────────────────────────────────────────────
       EMOJI PICKER
    ───────────────────────────────────────────────── */
    #emoji-picker-wrap {
      display: none; position: absolute; bottom: 100%; left: 0; margin-bottom: 6px;
      z-index: 50; box-shadow: 0 8px 32px rgba(0,0,0,0.15); border-radius: 16px; overflow: hidden;
    }
    #emoji-picker-wrap.open { display: block; }
    emoji-picker { --background: #f5f0e8; --border-color: rgba(13,13,13,0.1); --emoji-size: 1.25rem; --num-columns: 7; }

    /* ─────────────────────────────────────────────────
       AUTH
    ───────────────────────────────────────────────── */
    #auth-email, #auth-password, #message-input, #user-search {
      /* BUG FIX #2: font-size ≥ 16px prevents iOS auto-zoom on focus */
      font-size: 16px !important;
    }
    .auth-card { box-shadow: 0 0 0 1px #d4cfc4, 0 12px 40px rgba(0,0,0,0.09); }

    /* ─────────────────────────────────────────────────
       MOBILE SIDEBAR
    ───────────────────────────────────────────────── */
    @media (max-width: 640px) {
      #sidebar {
        position: absolute; top: 0; left: 0; bottom: 0;
        z-index: 100; transform: translateX(-100%);
      }
      #sidebar.open {
        transform: translateX(0);
        box-shadow: 4px 0 24px rgba(0,0,0,0.18);
      }
    }
    @media (min-width: 641px) {
      #sidebar-overlay { display: none !important; }
      #menu-btn        { display: none !important; }
    }

    #sidebar-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.3); z-index: 99;
    }

    /* ─────────────────────────────────────────────────
       MODALS
    ───────────────────────────────────────────────── */
    .modal-card { box-shadow: 0 0 0 1px #d4cfc4, 0 20px 60px rgba(0,0,0,0.15); }
    .user-result { cursor: pointer; transition: background 0.14s; }
    .user-result:hover { background: rgba(13,13,13,0.05); }

    /* Blocked overlay on message */
    .blocked-msg { font-style: italic; opacity: 0.5; }

    /* Notification toast */
    #notif-toast {
      position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 1000;
      background: #0d0d0d; color: #f5f0e8;
      border-radius: 14px; padding: 12px 16px; max-width: 280px;
      display: none; gap: 10px; align-items: center;
      box-shadow: 0 8px 32px rgba(0,0,0,0.25);
      animation: slide-up 0.2s ease-out;
      cursor: pointer;
    }
    #notif-toast.show { display: flex; }
  </style>
</head>
<body>

<!-- Ambient background blobs -->
<div style="position:fixed;top:0;right:0;width:26rem;height:26rem;border-radius:50%;background:radial-gradient(circle,rgba(200,75,49,.13),transparent);transform:translate(35%,-35%);filter:blur(70px);pointer-events:none;z-index:0"></div>
<div style="position:fixed;bottom:0;left:0;width:22rem;height:22rem;border-radius:50%;background:radial-gradient(circle,rgba(90,122,94,.1),transparent);transform:translate(-35%,35%);filter:blur(70px);pointer-events:none;z-index:0"></div>

<!-- ════════════════════ NOTIFICATION TOAST ════════════════════ -->
<div id="notif-toast" onclick="onToastClick()">
  <div id="notif-toast-avatar" style="width:32px;height:32px;border-radius:50%;background:#c84b31;display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:500;flex-shrink:0"></div>
  <div style="min-width:0">
    <p id="notif-toast-sender" style="font-size:.65rem;letter-spacing:.07em;text-transform:uppercase;color:#8a9ba8;margin-bottom:2px"></p>
    <p id="notif-toast-body"   style="font-size:.82rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis"></p>
  </div>
</div>

<!-- ════════════════════ AUTH SCREEN ════════════════════ -->
<div id="auth-screen" style="position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;padding:1rem;background:#f5f0e8">
  <div class="auth-card w-full max-w-sm bg-paper rounded-2xl p-7 animate-fade-in">
    <div class="mb-7">
      <div class="flex items-center gap-2 mb-1.5">
        <div class="w-1.5 h-1.5 rounded-full bg-rust animate-pulse-dot"></div>
        <span style="font-size:.62rem;letter-spacing:.09em;text-transform:uppercase" class="text-mist">messenger</span>
      </div>
      <h1 class="font-display text-4xl font-light text-ink leading-none">Relay<span class="text-rust">.</span></h1>
      <p class="text-xs text-mist mt-1">private conversations</p>
    </div>

    <div class="flex gap-1 p-1 bg-cream rounded-xl mb-5">
      <button id="tab-login"  onclick="showTab('login')"  class="flex-1 py-1.5 text-xs rounded-lg bg-paper text-ink transition-all">Login</button>
      <button id="tab-signup" onclick="showTab('signup')" class="flex-1 py-1.5 text-xs rounded-lg text-mist transition-all">Sign Up</button>
    </div>

    <form id="auth-form" onsubmit="handleAuth(event)" class="space-y-3" novalidate>
      <div>
        <label class="block mb-1" style="font-size:.62rem;letter-spacing:.09em;text-transform:uppercase;color:#8a9ba8">Email</label>
        <input id="auth-email" type="email" required placeholder="you@example.com" autocomplete="email"
          class="w-full bg-cream border border-transparent focus:border-ink/25 rounded-xl px-4 py-2.5 text-sm text-ink placeholder-mist/50 outline-none transition-colors" />
      </div>
      <div>
        <label class="block mb-1" style="font-size:.62rem;letter-spacing:.09em;text-transform:uppercase;color:#8a9ba8">Password</label>
        <input id="auth-password" type="password" required placeholder="••••••••" autocomplete="current-password"
          class="w-full bg-cream border border-transparent focus:border-ink/25 rounded-xl px-4 py-2.5 text-sm text-ink placeholder-mist/50 outline-none transition-colors" />
      </div>
      <div id="auth-error" class="hidden text-xs text-rust bg-rust/10 border border-rust/20 rounded-xl px-3 py-2"></div>
      <button type="submit" id="auth-submit"
        class="w-full bg-ink text-paper py-2.5 rounded-xl text-sm hover:bg-ink/80 active:scale-[0.98] transition-all flex items-center justify-center gap-2">
        <span id="auth-btn-text">Login</span>
        <span id="auth-spinner" class="hidden w-3.5 h-3.5 border-2 border-paper/30 border-t-paper rounded-full spin"></span>
      </button>
    </form>

    <p class="text-center text-xs text-mist mt-5">
      <span id="switch-label">No account?</span>
      <button onclick="showTab(currentTab==='login'?'signup':'login')" class="text-ink underline underline-offset-2 ml-1"><span id="switch-btn">Sign up</span></button>
    </p>
  </div>
</div>

<!-- ════════════════════ MAIN APP ════════════════════ -->
<div id="app" style="display:none">

  <div id="sidebar-overlay" onclick="closeSidebar()"></div>

  <!-- ══════ SIDEBAR ══════ -->
  <div id="sidebar">
    <!-- Header -->
    <div class="flex-shrink-0 px-4 pt-5 pb-3 border-b border-ink/10">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h1 class="font-display text-2xl font-semibold text-ink leading-none">Relay<span class="text-rust">.</span></h1>
          <p style="font-size:.58rem;letter-spacing:.1em;text-transform:uppercase" class="text-mist mt-0.5">messages</p>
        </div>
        <button onclick="handleSignOut()" title="Sign out"
          class="w-8 h-8 flex items-center justify-center rounded-lg bg-paper/60 hover:bg-rust/10 text-mist hover:text-rust transition-all">
          <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/>
          </svg>
        </button>
      </div>

      <!-- My profile row -->
      <div class="flex items-center gap-2.5 mb-3 bg-paper/40 rounded-xl px-3 py-2">
        <div class="relative flex-shrink-0">
          <div id="my-avatar" class="w-8 h-8 rounded-full bg-rust flex items-center justify-center text-paper text-xs font-medium"></div>
          <span class="presence-dot online absolute -bottom-0.5 -right-0.5"></span>
        </div>
        <p id="my-email" class="text-xs text-ink truncate flex-1 min-w-0"></p>
      </div>

      <!-- New conversation button -->
      <button onclick="openNewChat()"
        class="w-full flex items-center justify-center gap-2 bg-ink text-paper text-xs py-2 rounded-xl hover:bg-rust active:scale-[0.98] transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        New Conversation
      </button>
    </div>

    <!-- Conversations list -->
    <div id="conv-list" class="py-2">
      <div id="conv-loading" class="flex items-center justify-center py-8">
        <div class="w-4 h-4 border-2 border-ink/15 border-t-ink/50 rounded-full spin"></div>
      </div>
      <p id="conv-empty" class="hidden text-center text-xs text-mist py-8 px-4">No conversations yet.<br>Start one above!</p>
    </div>
  </div>

  <!-- ══════ CHAT PANEL ══════ -->
  <div id="chat-panel">

    <!-- Chat header -->
    <header class="flex-shrink-0 bg-paper/95 backdrop-blur-sm border-b border-ink/10 px-4 py-3 flex items-center gap-3">
      <button id="menu-btn" onclick="openSidebar()"
        class="w-8 h-8 flex items-center justify-center rounded-lg bg-cream text-mist flex-shrink-0">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>

      <!-- Partner info -->
      <div class="flex items-center gap-2 flex-1 min-w-0">
        <div class="relative flex-shrink-0">
          <div id="chat-header-avatar" class="w-8 h-8 rounded-full bg-sage flex items-center justify-center text-paper text-xs font-medium hidden"></div>
          <span id="chat-header-presence" class="presence-dot offline absolute -bottom-0.5 -right-0.5 hidden"></span>
        </div>
        <div class="min-w-0">
          <p id="chat-header-name" class="text-sm text-ink truncate font-medium">Select a conversation</p>
          <p id="chat-header-status" style="font-size:.6rem;letter-spacing:.08em;text-transform:uppercase" class="text-mist">—</p>
        </div>
      </div>

      <!-- Action buttons (block / remove) — visible when chat open -->
      <div id="chat-actions" class="hidden flex items-center gap-1">
        <button id="block-btn" onclick="toggleBlock()" title="Block / Unblock"
          class="w-8 h-8 flex items-center justify-center rounded-lg bg-cream text-mist hover:bg-rust/10 hover:text-rust transition-all">
          <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
        </button>
        <button onclick="removeConversation()" title="Remove conversation"
          class="w-8 h-8 flex items-center justify-center rounded-lg bg-cream text-mist hover:bg-rust/10 hover:text-rust transition-all">
          <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
        </button>
      </div>
    </header>

    <!-- Messages scroll area -->
    <div id="chat-messages" class="px-3 sm:px-5 py-4">
      <div id="chat-empty" class="flex flex-col items-center justify-center py-20 text-center select-none">
        <div class="text-4xl mb-3 opacity-10">◈</div>
        <p class="font-display text-2xl font-light" style="color:rgba(13,13,13,.18)">Your messages</p>
        <p class="text-xs text-mist mt-1">Select a conversation or start a new one</p>
      </div>
      <div id="messages-container"></div>
    </div>

    <!-- Error banner -->
    <div id="chat-error" class="hidden mx-3 mb-2 bg-rust/10 border border-rust/20 text-rust text-xs rounded-xl px-3 py-2 flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      <span id="chat-error-text"></span>
    </div>

    <!-- ══ INPUT AREA ══
         BUG FIX #2: flex-shrink:0 in CSS keeps this pinned at
         the bottom of the flex column. No fixed positioning needed.
    -->
    <div id="input-area" class="hidden">

      <!-- Image preview bar -->
      <div id="img-preview-bar" class="img-preview-bar mb-2 mx-1 flex items-center gap-3 bg-cream rounded-xl px-3 py-2 border border-ink/10">
        <img id="img-preview-thumb" src="" alt="preview" />
        <div class="flex-1 min-w-0">
          <p id="img-preview-name" class="text-xs text-ink truncate"></p>
          <p style="font-size:.6rem" class="text-mist">Image ready to send</p>
        </div>
        <button onclick="clearImageAttachment()" class="text-mist hover:text-rust transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>

      <!-- Voice recording bar -->
      <div id="voice-bar" class="voice-bar mb-2 mx-1 bg-cream rounded-2xl px-4 py-2.5 border border-rust/25">
        <div class="rec-pulse w-2 h-2 rounded-full bg-rust flex-shrink-0"></div>
        <span class="text-xs text-rust flex-1">Recording…</span>
        <span id="rec-timer" class="text-xs text-rust font-mono">0:00</span>
        <button type="button" onclick="cancelRecording()" class="text-xs text-mist hover:text-rust transition-colors ml-2">Cancel</button>
      </div>

      <!-- Emoji picker (absolutely positioned above bar) -->
      <div style="position:relative;">
        <div id="emoji-picker-wrap">
          <emoji-picker id="emoji-picker"></emoji-picker>
        </div>

        <!-- Blocked banner (shows when the other user is blocked) -->
        <div id="blocked-banner" class="hidden mx-1 mb-2 bg-amber/10 border border-amber/30 text-amber text-xs rounded-xl px-3 py-2 text-center">
          You have blocked this person. Unblock to send messages.
        </div>

        <!-- Text + media input row -->
        <form id="message-form" onsubmit="sendTextMessage(event)" class="flex items-center gap-2">

          <!-- Emoji toggle -->
          <button type="button" id="emoji-btn" onclick="toggleEmojiPicker()"
            class="flex-shrink-0 w-10 h-10 flex items-center justify-center rounded-2xl bg-cream text-mist hover:text-rust hover:bg-rust/10 transition-all active:scale-90">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/>
            </svg>
          </button>

          <!-- Text input -->
          <input id="message-input" type="text" placeholder="Write a message…" autocomplete="off"
            class="flex-1 min-w-0 bg-cream border border-transparent focus:border-ink/20 rounded-2xl px-4 py-2.5 text-sm text-ink placeholder-mist/50 outline-none transition-colors" />

          <!-- Image upload -->
          <input id="img-file-input" type="file" accept="image/*" class="hidden" onchange="onImageSelected(event)" />
          <button type="button" onclick="document.getElementById('img-file-input').click()"
            class="flex-shrink-0 w-10 h-10 flex items-center justify-center rounded-2xl bg-cream text-mist hover:text-sage hover:bg-sage/10 transition-all active:scale-90">
            <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>
            </svg>
          </button>

          <!-- Voice mic -->
          <button type="button" id="voice-btn" onclick="toggleVoice()"
            class="flex-shrink-0 w-10 h-10 flex items-center justify-center rounded-2xl bg-cream text-mist hover:text-rust hover:bg-rust/10 transition-all active:scale-90">
            <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
              <line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>
            </svg>
            <svg id="stop-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>
          </button>

          <!-- Send -->
          <button type="submit" id="send-btn"
            class="flex-shrink-0 w-10 h-10 flex items-center justify-center bg-ink text-paper rounded-2xl hover:bg-rust active:scale-90 transition-all duration-150">
            <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22,2 15,22 11,13 2,9"/>
            </svg>
          </button>
        </form>
      </div><!-- /relative wrap -->
    </div><!-- /input-area -->
  </div><!-- /chat-panel -->
</div><!-- /app -->

<!-- ════════════════════ NEW CHAT MODAL ════════════════════ -->
<div id="new-chat-modal" class="hidden fixed inset-0 z-[150] flex items-center justify-center p-4">
  <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" onclick="closeNewChat()"></div>
  <div class="modal-card relative bg-paper rounded-2xl w-full max-w-sm p-6 animate-fade-in">
    <div class="flex items-center justify-between mb-4">
      <h2 class="font-display text-xl font-light text-ink">New conversation</h2>
      <button onclick="closeNewChat()" class="w-7 h-7 flex items-center justify-center rounded-lg bg-cream text-mist hover:text-rust transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>

    <!--
      FEATURE: Predictive Search
      Uses oninput (fires on every keystroke, not just onchange which may
      miss programmatic changes). Filters from the start of the email
      using ilike 'query%' so "a" returns all emails beginning with "a".
    -->
    <div class="relative mb-3">
      <input id="user-search" type="text" placeholder="Search by email…" oninput="searchUsers(this.value)"
        class="w-full bg-cream border border-transparent focus:border-ink/25 rounded-xl px-4 py-2.5 text-sm text-ink placeholder-mist/50 outline-none transition-colors" />
      <div id="search-spinner" class="hidden absolute right-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 border-2 border-ink/20 border-t-ink/60 rounded-full spin"></div>
    </div>

    <div id="user-results" class="max-h-52 overflow-y-auto rounded-xl">
      <p class="text-xs text-mist text-center py-4">Type to search for users</p>
    </div>
    <div id="modal-error" class="hidden mt-3 text-xs text-rust bg-rust/10 border border-rust/20 rounded-xl px-3 py-2"></div>
  </div>
</div>

<!-- ════════════════════ CONFIRM MODAL ════════════════════ -->
<div id="confirm-modal" class="hidden fixed inset-0 z-[160] flex items-center justify-center p-4">
  <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" onclick="closeConfirm()"></div>
  <div class="modal-card relative bg-paper rounded-2xl w-full max-w-xs p-6 animate-fade-in text-center">
    <p id="confirm-text" class="text-sm text-ink mb-5"></p>
    <div class="flex gap-2">
      <button onclick="closeConfirm()" class="flex-1 py-2 rounded-xl bg-cream text-sm text-mist hover:bg-cream/80 transition-all">Cancel</button>
      <button id="confirm-ok"          class="flex-1 py-2 rounded-xl bg-rust text-paper text-sm hover:bg-rust/80 transition-all">Confirm</button>
    </div>
  </div>
</div>

<!-- ════════════════════════════════════════════════
     JAVASCRIPT — Production-grade, fully documented
════════════════════════════════════════════════ -->
<script>
'use strict';

/* ══════════════════════════════════════════════════════
   CONFIG
   ──────────────────────────────────────────────────────
   BUG FIX #1 — "Bucket not found":
   The STORAGE_BUCKET constant must match EXACTLY the name
   you created in Supabase → Storage (case-sensitive).
   Default is 'voice-messages'. If you named it differently
   (e.g. 'voice_messages' with underscore), change it here.
   Also ensure:
     1. The bucket exists in Supabase → Storage → Buckets
     2. The bucket is set to PUBLIC (or you have a signed-URL policy)
     3. Supabase Storage policy allows INSERT for authenticated users:
        CREATE POLICY "allow uploads" ON storage.objects
        FOR INSERT TO authenticated WITH CHECK (bucket_id = 'voice-messages');
   ══════════════════════════════════════════════════════ */
const SUPABASE_URL      = 'https://xvvzxjaddcfvedtjudjx.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2dnp4amFkZGNmdmVkdGp1ZGp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwOTM1ODAsImV4cCI6MjA4NzY2OTU4MH0.OdZpsbqU-WjB9beIX58-t9hH5vone-JJmFYIvLlN9hw';
const STORAGE_BUCKET    = 'voice-messages';   // ← must match Supabase bucket name exactly
const IMAGE_BUCKET      = 'chat-images';      // ← create this bucket too (public)
const PRESENCE_INTERVAL = 30_000;            // heartbeat every 30 s

const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { flowType:'pkce', autoRefreshToken:true, persistSession:true, detectSessionInUrl:true }
});

/* ══════════════════════════════════════════════════════
   APP STATE — single source of truth
   ══════════════════════════════════════════════════════ */
const state = {
  user:          null,   // current Supabase user
  activeConvId:  null,   // UUID of open conversation
  activePartner: null,   // { id, email } of chat partner
  conversations: [],     // loaded conversation objects
  onlineUsers:   new Set(),  // user IDs currently online
  blockedUsers:  new Set(),  // user IDs blocked by me
  unreadCounts:  {},     // { convId: number }
  notifToastTimeout: null,
};

/* ══════════════════════════════════════════════════════
   DOM REFS — cached once, used everywhere
   ══════════════════════════════════════════════════════ */
const DOM = {
  authScreen:     document.getElementById('auth-screen'),
  app:            document.getElementById('app'),
  chatMessages:   document.getElementById('chat-messages'),
  msgsContainer:  document.getElementById('messages-container'),
  chatEmpty:      document.getElementById('chat-empty'),
  inputArea:      document.getElementById('input-area'),
  convList:       document.getElementById('conv-list'),
  msgInput:       document.getElementById('message-input'),
  imgPreviewBar:  document.getElementById('img-preview-bar'),
  blockedBanner:  document.getElementById('blocked-banner'),
  voiceBar:       document.getElementById('voice-bar'),
  chatActions:    document.getElementById('chat-actions'),
};

/* ══════════════════════════════════════════════════════
   BUG FIX #2 — iOS KEYBOARD / VIEWPORT
   ────────────────────────────────────────────────────────
   On iOS Safari the WKWebView fires visualViewport.resize
   events when the soft keyboard opens/closes. The native
   window.innerHeight does NOT change (it keeps the full
   screen height), so css 100vh and position:fixed elements
   end up underneath the keyboard.

   The fix:
     • Use dvh (dynamic viewport height) in CSS — already done.
     • As a fallback for older iOS, listen to visualViewport
       resize and forcibly set #app height to the visible height.
     • Keep input-area in normal flex flow (NOT fixed/absolute),
       so it naturally lives at the bottom of the visible viewport.
   ══════════════════════════════════════════════════════ */
function initViewportFix() {
  if (!window.visualViewport) return; // not iOS / older browser, dvh handles it

  const $app = document.getElementById('app');

  const applyHeight = () => {
    // visualViewport.height = height of visible area (excludes keyboard)
    $app.style.height = `${window.visualViewport.height}px`;
  };

  window.visualViewport.addEventListener('resize', applyHeight);
  window.visualViewport.addEventListener('scroll', applyHeight);
  applyHeight(); // run once on load
}

/* ══════════════════════════════════════════════════════
   AUTH
   ══════════════════════════════════════════════════════ */
// Handle PKCE code exchange on redirect
(async () => {
  if (window.location.search.includes('code=')) {
    try { await sb.auth.exchangeCodeForSession(window.location.href); } catch(_) {}
    window.history.replaceState({}, '', window.location.pathname);
  }
})();

sb.auth.onAuthStateChange((_event, session) => {
  if (session?.user) { state.user = session.user; enterApp(); }
  else               { state.user = null;          enterAuth(); }
});

function showTab(tab) {
  const isLogin = tab === 'login';
  document.getElementById('tab-login').className  = `flex-1 py-1.5 text-xs rounded-lg transition-all ${isLogin  ? 'bg-paper text-ink' : 'text-mist'}`;
  document.getElementById('tab-signup').className = `flex-1 py-1.5 text-xs rounded-lg transition-all ${!isLogin ? 'bg-paper text-ink' : 'text-mist'}`;
  document.getElementById('auth-btn-text').textContent = isLogin ? 'Login' : 'Create Account';
  document.getElementById('switch-label').textContent  = isLogin ? 'No account?' : 'Have an account?';
  document.getElementById('switch-btn').textContent    = isLogin ? 'Sign up' : 'Login';
  document.getElementById('auth-error').classList.add('hidden');
  window.currentTab = tab;
}
window.currentTab = 'login';

async function handleAuth(e) {
  e.preventDefault();
  const email    = document.getElementById('auth-email').value.trim();
  const password = document.getElementById('auth-password').value;
  if (!email || !password) return;
  setAuthLoading(true);
  document.getElementById('auth-error').classList.add('hidden');
  try {
    if (window.currentTab === 'login') {
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if (error) throw error;
    } else {
      const { data, error } = await sb.auth.signUp({ email, password, options:{ emailRedirectTo:window.location.origin } });
      if (error) throw error;
      if (data?.user && !data.session) {
        showAuthErr('✓ Check your inbox to confirm your email, then login.');
        setAuthLoading(false); return;
      }
    }
  } catch(err) {
    const m = err.message || '';
    if (m.includes('Invalid login'))     showAuthErr('Wrong email or password.');
    else if (m.includes('confirmed'))    showAuthErr('Please confirm your email first.');
    else if (m.includes('registered'))   showAuthErr('Account exists — try logging in.');
    else                                 showAuthErr(m || 'Authentication failed.');
  } finally { setAuthLoading(false); }
}

function setAuthLoading(on) {
  document.getElementById('auth-btn-text').classList.toggle('hidden', on);
  document.getElementById('auth-spinner').classList.toggle('hidden', !on);
  document.getElementById('auth-submit').disabled = on;
}
function showAuthErr(m) {
  const el = document.getElementById('auth-error');
  el.textContent = m; el.classList.remove('hidden');
}

async function handleSignOut() {
  cleanup();
  await sb.auth.signOut();
}

/* ══════════════════════════════════════════════════════
   SCREEN TRANSITIONS
   ══════════════════════════════════════════════════════ */
function enterAuth() {
  cleanup();
  DOM.app.style.display = 'none';
  DOM.authScreen.style.display = 'flex';
  DOM.msgsContainer.innerHTML = '';
}

async function enterApp() {
  DOM.authScreen.style.display = 'none';
  DOM.app.style.display = 'flex';
  initViewportFix();
  document.getElementById('my-avatar').textContent = initial(state.user.email);
  document.getElementById('my-email').textContent  = state.user.email;
  await Promise.all([
    loadBlockedUsers(),
    upsertProfile(),
    loadConversations(),
    requestNotifPermission(),
  ]);
  subscribeConversations();
  startPresenceHeartbeat();
  subscribePresence();
  setupEmojiPicker();
}

/* ══════════════════════════════════════════════════════
   PRESENCE MANAGEMENT
   ──────────────────────────────────────────────────────
   We upsert a `last_seen` field in the profiles table.
   A user is "online" if last_seen < 90 seconds ago.
   ══════════════════════════════════════════════════════ */
let presenceTimer = null;

async function upsertProfile() {
  await sb.from('profiles').upsert(
    { id: state.user.id, email: state.user.email, last_seen: new Date().toISOString() },
    { onConflict:'id' }
  );
}

function startPresenceHeartbeat() {
  // Update last_seen every 30s so other users see us online
  presenceTimer = setInterval(async () => {
    await sb.from('profiles').update({ last_seen: new Date().toISOString() }).eq('id', state.user.id);
  }, PRESENCE_INTERVAL);
}

function subscribePresence() {
  // Listen for ANY profile update and refresh online status
  sb.channel('presence')
    .on('postgres_changes', { event:'UPDATE', schema:'public', table:'profiles' }, (payload) => {
      const uid     = payload.new.id;
      const seenAt  = new Date(payload.new.last_seen);
      const isOnline = (Date.now() - seenAt.getTime()) < 90_000;

      if (isOnline) state.onlineUsers.add(uid);
      else          state.onlineUsers.delete(uid);

      // Refresh conv-list presence dots
      refreshPresenceDots();

      // Update chat header if we're talking to this user
      if (state.activePartner?.id === uid) {
        updateChatHeaderPresence(isOnline);
      }
    })
    .subscribe();
}

function refreshPresenceDots() {
  document.querySelectorAll('[data-presence-uid]').forEach(dot => {
    const uid = dot.dataset.presenceUid;
    dot.className = `presence-dot ${state.onlineUsers.has(uid) ? 'online' : 'offline'}`;
  });
}

function updateChatHeaderPresence(isOnline) {
  const dot = document.getElementById('chat-header-presence');
  const statusEl = document.getElementById('chat-header-status');
  dot.className = `presence-dot ${isOnline ? 'online' : 'offline'} absolute -bottom-0.5 -right-0.5`;
  statusEl.textContent = isOnline ? 'online' : 'offline';
}

/* ══════════════════════════════════════════════════════
   BLOCK / SOCIAL CONTROLS
   ──────────────────────────────────────────────────────
   Blocks are stored in a `blocks` table:
     blocker_id (UUID), blocked_id (UUID)

   Security model:
   • Frontend: hides input, shows blocked banner
   • Backend (Supabase RLS recommended):
     CREATE POLICY "block check" ON public.messages
     FOR INSERT TO authenticated
     USING (
       NOT EXISTS (
         SELECT 1 FROM blocks
         WHERE (blocker_id = auth.uid() AND blocked_id = NEW.sender_id)
            OR (blocker_id = NEW.sender_id AND blocked_id = auth.uid())
       )
     );
   ══════════════════════════════════════════════════════ */
async function loadBlockedUsers() {
  const { data } = await sb.from('blocks').select('blocked_id').eq('blocker_id', state.user.id);
  state.blockedUsers = new Set((data || []).map(r => r.blocked_id));
}

async function toggleBlock() {
  if (!state.activePartner) return;
  const partnerId = state.activePartner.id;
  const isBlocked = state.blockedUsers.has(partnerId);

  const action = isBlocked ? 'Unblock' : 'Block';
  confirmDialog(`${action} ${state.activePartner.email}?`, async () => {
    if (isBlocked) {
      await sb.from('blocks').delete()
        .eq('blocker_id', state.user.id)
        .eq('blocked_id', partnerId);
      state.blockedUsers.delete(partnerId);
    } else {
      await sb.from('blocks').insert({ blocker_id: state.user.id, blocked_id: partnerId });
      state.blockedUsers.add(partnerId);
    }
    updateBlockUI();
  });
}

function updateBlockUI() {
  if (!state.activePartner) return;
  const isBlocked = state.blockedUsers.has(state.activePartner.id);
  const blockBtn = document.getElementById('block-btn');

  // Tint the block button red when active
  blockBtn.style.color = isBlocked ? '#c84b31' : '';

  // Show/hide blocked banner & disable input
  DOM.blockedBanner.classList.toggle('hidden', !isBlocked);
  DOM.msgInput.disabled   = isBlocked;
  document.getElementById('send-btn').disabled = isBlocked;
  document.getElementById('voice-btn').disabled = isBlocked;
}

async function removeConversation() {
  if (!state.activeConvId) return;
  confirmDialog('Remove this conversation? Messages will be deleted.', async () => {
    await sb.from('messages').delete().eq('conversation_id', state.activeConvId);
    await sb.from('conversations').delete().eq('id', state.activeConvId);
    state.activeConvId  = null;
    state.activePartner = null;
    DOM.msgsContainer.innerHTML = '';
    DOM.chatEmpty.style.display = 'flex';
    DOM.inputArea.classList.add('hidden');
    DOM.chatActions.classList.add('hidden');
    document.getElementById('chat-header-avatar').classList.add('hidden');
    document.getElementById('chat-header-presence').classList.add('hidden');
    document.getElementById('chat-header-name').textContent = 'Select a conversation';
    document.getElementById('chat-header-status').textContent = '—';
    await loadConversations();
  });
}

/* ══════════════════════════════════════════════════════
   CONVERSATIONS
   ══════════════════════════════════════════════════════ */
async function loadConversations() {
  document.getElementById('conv-loading').classList.remove('hidden');
  document.getElementById('conv-empty').classList.add('hidden');
  document.querySelectorAll('.conv-item').forEach(el => el.remove());

  const { data } = await sb.from('conversations')
    .select('*')
    .or(`user1_id.eq.${state.user.id},user2_id.eq.${state.user.id}`)
    .order('last_message_at', { ascending:false, nullsFirst:false });

  document.getElementById('conv-loading').classList.add('hidden');
  state.conversations = data || [];

  if (!state.conversations.length) {
    document.getElementById('conv-empty').classList.remove('hidden');
    return;
  }
  state.conversations.forEach(c => renderConvItem(c));
}

function renderConvItem(conv) {
  const isUser1   = conv.user1_id === state.user.id;
  const otherId   = isUser1 ? conv.user2_id   : conv.user1_id;
  const otherEmail= isUser1 ? conv.user2_email : conv.user1_email;
  const isOnline  = state.onlineUsers.has(otherId);
  const isBlocked = state.blockedUsers.has(otherId);
  const unread    = state.unreadCounts[conv.id] || 0;

  const existing = document.getElementById(`conv-${conv.id}`);
  if (existing) existing.remove();

  const ts = conv.last_message_at
    ? new Date(conv.last_message_at).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' })
    : '';

  const div = document.createElement('div');
  div.id = `conv-${conv.id}`;
  div.className = `conv-item px-4 py-3 flex items-center gap-3 ${state.activeConvId === conv.id ? 'active' : ''} ${isBlocked ? 'blocked-item' : ''}`;
  div.onclick = () => openConversation(conv.id, otherId, otherEmail);

  div.innerHTML = `
    <div class="relative flex-shrink-0">
      <div class="w-9 h-9 rounded-full bg-sage flex items-center justify-center text-paper text-sm font-medium">${initial(otherEmail)}</div>
      <span class="presence-dot ${isOnline ? 'online' : 'offline'} absolute -bottom-0.5 -right-0.5" data-presence-uid="${otherId}"></span>
    </div>
    <div class="flex-1 min-w-0">
      <div class="flex items-center justify-between gap-1">
        <p class="text-sm text-ink truncate font-medium">${escHtml(otherEmail)}</p>
        <span style="font-size:.6rem" class="text-mist flex-shrink-0">${ts}</span>
      </div>
      <p class="text-xs text-mist truncate">${escHtml(conv.last_message_preview || '—')}</p>
    </div>
    ${unread > 0 ? `<span class="unread-badge">${unread > 9 ? '9+' : unread}</span>` : ''}
  `;

  DOM.convList.appendChild(div);
}

function subscribeConversations() {
  const handle = () => loadConversations();
  sb.channel('convs:' + state.user.id)
    .on('postgres_changes', { event:'*', schema:'public', table:'conversations', filter:`user1_id=eq.${state.user.id}` }, handle)
    .on('postgres_changes', { event:'*', schema:'public', table:'conversations', filter:`user2_id=eq.${state.user.id}` }, handle)
    .subscribe();
}

/* ══════════════════════════════════════════════════════
   OPEN CONVERSATION
   ══════════════════════════════════════════════════════ */
let msgChannel = null;

async function openConversation(convId, partnerId, partnerEmail) {
  state.activeConvId  = convId;
  state.activePartner = { id: partnerId, email: partnerEmail };
  closeSidebar();

  // Clear unread for this conv
  delete state.unreadCounts[convId];
  const badge = document.querySelector(`#conv-${convId} .unread-badge`);
  if (badge) badge.remove();

  // Header
  const av = document.getElementById('chat-header-avatar');
  av.textContent = initial(partnerEmail);
  av.classList.remove('hidden');
  const presenceDot = document.getElementById('chat-header-presence');
  presenceDot.classList.remove('hidden');
  document.getElementById('chat-header-name').textContent = partnerEmail;
  updateChatHeaderPresence(state.onlineUsers.has(partnerId));

  // Show actions
  DOM.chatActions.classList.remove('hidden');
  DOM.chatActions.style.display = 'flex';

  // Activate conv item
  document.querySelectorAll('.conv-item').forEach(el => el.classList.remove('active'));
  document.getElementById(`conv-${convId}`)?.classList.add('active');

  // Show input, update block state
  DOM.chatEmpty.style.display = 'none';
  DOM.inputArea.classList.remove('hidden');
  updateBlockUI();

  // Load messages
  DOM.msgsContainer.innerHTML = '';
  const loader = document.createElement('div');
  loader.className = 'flex items-center justify-center py-12';
  loader.innerHTML = '<div class="w-4 h-4 border-2 border-ink/15 border-t-ink/50 rounded-full spin"></div>';
  DOM.msgsContainer.appendChild(loader);

  if (msgChannel) { await sb.removeChannel(msgChannel); msgChannel = null; }

  const { data, error } = await sb.from('messages')
    .select('*')
    .eq('conversation_id', convId)
    .order('created_at', { ascending:true })
    .limit(200);

  loader.remove();
  if (!error && data?.length) {
    data.forEach(renderMsg);
    scrollBottom(false);
  } else if (!error) {
    DOM.msgsContainer.innerHTML = '<p class="text-center text-xs text-mist py-8">No messages yet. Say hello!</p>';
  }

  subscribeMessages(convId);
}

/* ══════════════════════════════════════════════════════
   REALTIME MESSAGES
   ══════════════════════════════════════════════════════ */
function subscribeMessages(convId) {
  msgChannel = sb.channel('msgs:' + convId)
    .on('postgres_changes', { event:'INSERT', schema:'public', table:'messages', filter:`conversation_id=eq.${convId}` },
      (payload) => {
        const msg = payload.new;
        // Remove placeholder
        const ph = DOM.msgsContainer.querySelector('p.text-center.text-xs.text-mist');
        if (ph) ph.remove();

        renderMsg(msg);
        scrollBottom(true);

        // ── NOTIFICATION SYSTEM ──────────────────────────────
        // Only notify when message is from the OTHER person
        if (msg.sender_id !== state.user.id) {
          // Increment unread if this conv is NOT active (or window unfocused)
          if (!document.hasFocus() || state.activeConvId !== convId) {
            state.unreadCounts[convId] = (state.unreadCounts[convId] || 0) + 1;
            updateConvBadge(convId);
          }
          triggerNotification(msg);
        }
      })
    .subscribe((status) => {
      document.getElementById('chat-header-presence').className =
        `presence-dot ${status === 'SUBSCRIBED' ? 'online' : 'offline'} absolute -bottom-0.5 -right-0.5`;
    });
}

function updateConvBadge(convId) {
  const count = state.unreadCounts[convId] || 0;
  let badge = document.querySelector(`#conv-${convId} .unread-badge`);
  if (count <= 0) { badge?.remove(); return; }
  if (!badge) {
    badge = document.createElement('span');
    badge.className = 'unread-badge';
    document.getElementById(`conv-${convId}`)?.appendChild(badge);
  }
  badge.textContent = count > 9 ? '9+' : count;
}

/* ══════════════════════════════════════════════════════
   NOTIFICATION SYSTEM
   ──────────────────────────────────────────────────────
   Two-tier approach:
   1. Browser Push Notification (fires even when tab hidden)
   2. In-app toast (always visible, navigates on click)
   ══════════════════════════════════════════════════════ */
let notifClickConvId = null;

async function requestNotifPermission() {
  if ('Notification' in window && Notification.permission === 'default') {
    // We request permission after user interaction (entering app) to
    // avoid the browser's "too early to ask" block
    await Notification.requestPermission();
  }
}

function triggerNotification(msg) {
  const senderLabel = msg.sender_email || 'Someone';
  const bodyText    = msg.message_type === 'voice' ? '🎙 Voice message'
                    : msg.message_type === 'image' ? '🖼 Image'
                    : (msg.content || '').slice(0, 80);

  // 1. Browser notification (when tab not focused)
  if (!document.hasFocus() && 'Notification' in window && Notification.permission === 'granted') {
    const n = new Notification(`Relay — ${senderLabel}`, {
      body: bodyText,
      icon: 'https://emojicdn.elk.sh/✉️?style=apple',
      tag:  msg.conversation_id,   // groups notifications per conversation
    });
    n.onclick = () => { window.focus(); openConversation(msg.conversation_id, state.activePartner?.id, msg.sender_email); n.close(); };
  }

  // 2. In-app toast (always shown for incoming messages)
  notifClickConvId = msg.conversation_id;
  const toastAv    = document.getElementById('notif-toast-avatar');
  toastAv.textContent = initial(senderLabel);
  document.getElementById('notif-toast-sender').textContent = senderLabel;
  document.getElementById('notif-toast-body').textContent   = bodyText;

  const toast = document.getElementById('notif-toast');
  toast.classList.add('show');
  clearTimeout(state.notifToastTimeout);
  state.notifToastTimeout = setTimeout(() => toast.classList.remove('show'), 4500);
}

function onToastClick() {
  document.getElementById('notif-toast').classList.remove('show');
  if (notifClickConvId) {
    const conv = state.conversations.find(c => c.id === notifClickConvId);
    if (conv) {
      const isUser1 = conv.user1_id === state.user.id;
      openConversation(conv.id, isUser1 ? conv.user2_id : conv.user1_id, isUser1 ? conv.user2_email : conv.user1_email);
    }
  }
}

/* ══════════════════════════════════════════════════════
   RENDER MESSAGE BUBBLE
   ══════════════════════════════════════════════════════ */
function renderMsg(msg) {
  const isOwn = msg.sender_id === state.user.id;

  const wrapper = document.createElement('div');
  wrapper.className = `msg-bubble flex gap-2 mb-3 ${isOwn ? 'flex-row-reverse' : 'flex-row'}`;

  // Avatar
  const av = document.createElement('div');
  av.style.cssText = `width:1.75rem;height:1.75rem;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.68rem;font-weight:500;color:#f5f0e8;margin-top:2px;background:${isOwn?'#c84b31':'#5a7a5e'}`;
  av.textContent = initial(msg.sender_email);

  const col = document.createElement('div');
  col.className = `flex flex-col gap-0.5 min-w-0 ${isOwn ? 'items-end' : 'items-start'}`;
  col.style.maxWidth = 'min(80%, 360px)';

  const bubble = document.createElement('div');
  bubble.className = `px-3.5 py-2 text-sm leading-relaxed break-words w-full rounded-2xl ${isOwn ? 'bg-ink text-paper rounded-tr-sm' : 'bg-cream text-ink rounded-tl-sm'}`;

  if (msg.message_type === 'voice' && msg.voice_url) {
    // Voice bubble
    bubble.style.padding = '8px 12px';
    const vw = document.createElement('div');
    vw.className = 'flex items-center gap-2';

    const wave = document.createElement('div');
    wave.className = 'flex items-center gap-0.5 h-6';
    for (let i=0;i<5;i++) {
      const b = document.createElement('div');
      b.className = 'wave-bar';
      b.style.height = `${10 + Math.random()*12}px`;
      b.style.animationDuration = `${0.5 + Math.random()*0.5}s`;
      wave.appendChild(b);
    }

    const audio = document.createElement('audio');
    audio.src = msg.voice_url; audio.controls = true;
    if (msg.voice_duration) {
      const dur = document.createElement('span');
      dur.style.cssText = 'font-size:.6rem;opacity:0.55;white-space:nowrap;flex-shrink:0';
      dur.textContent = formatDuration(msg.voice_duration);
      vw.appendChild(wave); vw.appendChild(audio); vw.appendChild(dur);
    } else {
      vw.appendChild(wave); vw.appendChild(audio);
    }
    bubble.appendChild(vw);

  } else if (msg.message_type === 'image' && msg.image_url) {
    // Image bubble
    bubble.style.padding = '4px';
    const img = document.createElement('img');
    img.src = msg.image_url;
    img.style.cssText = 'max-width:220px;max-height:220px;border-radius:14px;display:block;cursor:zoom-in;';
    img.onclick = () => window.open(msg.image_url, '_blank');
    bubble.appendChild(img);

  } else {
    // Text bubble — textContent is XSS-safe
    bubble.textContent = msg.content || '';
  }

  const ts = document.createElement('p');
  ts.style.cssText = 'font-size:.58rem;letter-spacing:.04em;color:rgba(138,155,168,0.7);padding:0 4px';
  ts.textContent = new Date(msg.created_at).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });

  col.appendChild(bubble); col.appendChild(ts);
  wrapper.appendChild(av); wrapper.appendChild(col);
  DOM.msgsContainer.appendChild(wrapper);
}

/* ══════════════════════════════════════════════════════
   SEND TEXT MESSAGE
   ══════════════════════════════════════════════════════ */
async function sendTextMessage(e) {
  e.preventDefault();
  closeEmojiPicker();

  // Block check (double-checked on backend via RLS)
  if (state.blockedUsers.has(state.activePartner?.id)) return;

  const content = DOM.msgInput.value.trim();

  // If image is attached, send image first
  if (pendingImageFile) {
    await sendImageMessage(pendingImageFile, content);
    clearImageAttachment();
    DOM.msgInput.value = '';
    return;
  }

  if (!content || !state.activeConvId) return;
  DOM.msgInput.value = '';
  DOM.msgInput.disabled = true;

  try {
    const { error } = await sb.from('messages').insert([{
      conversation_id: state.activeConvId,
      sender_id:       state.user.id,
      sender_email:    state.user.email,
      content,
      message_type:    'text'
    }]);
    if (error) throw error;
    await updateConvPreview(state.activeConvId, content);
  } catch(err) {
    DOM.msgInput.value = content;
    showChatErr('Send failed: ' + err.message);
  } finally {
    DOM.msgInput.disabled = false;
    DOM.msgInput.focus();
  }
}

async function updateConvPreview(convId, preview) {
  await sb.from('conversations').update({
    last_message_preview: preview,
    last_message_at:      new Date().toISOString()
  }).eq('id', convId);
}

/* ══════════════════════════════════════════════════════
   IMAGE UPLOAD
   ══════════════════════════════════════════════════════ */
let pendingImageFile = null;

function onImageSelected(event) {
  const file = event.target.files?.[0];
  if (!file || !file.type.startsWith('image/')) return;
  pendingImageFile = file;

  const reader = new FileReader();
  reader.onload = (e) => {
    document.getElementById('img-preview-thumb').src = e.target.result;
    document.getElementById('img-preview-name').textContent = file.name;
    DOM.imgPreviewBar.classList.add('active');
    DOM.imgPreviewBar.style.display = 'flex';
  };
  reader.readAsDataURL(file);
  // Reset file input so same file can be re-selected
  event.target.value = '';
}

function clearImageAttachment() {
  pendingImageFile = null;
  DOM.imgPreviewBar.classList.remove('active');
  DOM.imgPreviewBar.style.display = 'none';
  document.getElementById('img-preview-thumb').src = '';
}

async function sendImageMessage(file, caption = null) {
  if (!state.activeConvId) return;

  /*
    BUG FIX #1 (Image variant):
    Same root cause as voice — bucket must exist and be public.
    Create 'chat-images' bucket in Supabase Storage → set to Public.
  */
  const ext  = file.name.split('.').pop() || 'jpg';
  const path = `${state.user.id}/${Date.now()}.${ext}`;

  try {
    const { error: upErr } = await sb.storage
      .from(IMAGE_BUCKET)
      .upload(path, file, { contentType: file.type, upsert: false });

    // Graceful fallback: if bucket doesn't exist, tell user clearly
    if (upErr) {
      if (upErr.message?.includes('Bucket not found')) {
        throw new Error(`Storage bucket "${IMAGE_BUCKET}" not found. Create it in Supabase → Storage and set it to Public.`);
      }
      throw upErr;
    }

    const { data: urlData } = sb.storage.from(IMAGE_BUCKET).getPublicUrl(path);

    await sb.from('messages').insert([{
      conversation_id: state.activeConvId,
      sender_id:       state.user.id,
      sender_email:    state.user.email,
      content:         caption || null,
      message_type:    'image',
      image_url:       urlData.publicUrl,
    }]);

    await updateConvPreview(state.activeConvId, caption || '🖼 Image');
  } catch(err) {
    showChatErr(err.message);
  }
}

/* ══════════════════════════════════════════════════════
   VOICE RECORDING
   ──────────────────────────────────────────────────────
   BUG FIX #1 — "Bucket not found":
   Root causes and remediation:
     (a) The bucket name in STORAGE_BUCKET doesn't match what
         was created in Supabase. Fix: check exact name above.
     (b) The bucket exists but is PRIVATE. Fix: set to Public
         in Supabase → Storage → Edit bucket → Public.
     (c) No INSERT policy for authenticated users. Fix: add
         the storage policy shown in the CONFIG comment above.
     (d) The Supabase project was on the free tier and storage
         was never enabled. Fix: enable it in Supabase dashboard.
   We now surface a clear actionable error message instead of
   the generic "Bucket not found".
   ══════════════════════════════════════════════════════ */
let mediaRecorder  = null;
let audioChunks    = [];
let isRecording    = false;
let recInterval    = null;
let recSeconds     = 0;

async function toggleVoice() {
  if (isRecording) stopRecording();
  else await startRecording();
}

async function startRecording() {
  if (!state.activeConvId) return;
  try {
    const stream   = await navigator.mediaDevices.getUserMedia({ audio: true });
    audioChunks    = [];
    const mimeType = ['audio/webm;codecs=opus','audio/webm','audio/mp4','audio/ogg']
                       .find(t => MediaRecorder.isTypeSupported(t)) || '';

    mediaRecorder = new MediaRecorder(stream, mimeType ? { mimeType } : {});
    mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
    mediaRecorder.onstop = async () => {
      stream.getTracks().forEach(t => t.stop());
      if (audioChunks.length) await uploadVoiceMessage(audioChunks, mediaRecorder.mimeType);
    };
    mediaRecorder.start(100);
    isRecording = true; recSeconds = 0;

    document.getElementById('voice-bar').classList.add('active');
    document.getElementById('mic-icon').classList.add('hidden');
    document.getElementById('stop-icon').classList.remove('hidden');
    document.getElementById('voice-btn').style.color = '#c84b31';
    DOM.msgInput.disabled = true;

    recInterval = setInterval(() => {
      recSeconds++;
      document.getElementById('rec-timer').textContent = formatDuration(recSeconds);
      if (recSeconds >= 120) stopRecording();
    }, 1000);
  } catch(err) {
    showChatErr('Microphone access denied. Allow mic permissions and try again.');
  }
}

function stopRecording() {
  if (mediaRecorder?.state !== 'inactive') mediaRecorder.stop();
  isRecording = false;
  clearInterval(recInterval);
  resetVoiceUI();
}

function cancelRecording() {
  audioChunks = [];
  if (mediaRecorder?.state !== 'inactive') {
    mediaRecorder.ondataavailable = null;
    mediaRecorder.onstop = () => mediaRecorder.stream?.getTracks().forEach(t => t.stop());
    mediaRecorder.stop();
  }
  isRecording = false;
  clearInterval(recInterval);
  resetVoiceUI();
}

function resetVoiceUI() {
  document.getElementById('voice-bar').classList.remove('active');
  document.getElementById('mic-icon').classList.remove('hidden');
  document.getElementById('stop-icon').classList.add('hidden');
  document.getElementById('voice-btn').style.color = '';
  document.getElementById('rec-timer').textContent = '0:00';
  DOM.msgInput.disabled = state.blockedUsers.has(state.activePartner?.id);
}

async function uploadVoiceMessage(chunks, mimeType) {
  if (!state.activeConvId) return;

  const ext  = mimeType.includes('mp4') ? 'mp4' : 'webm';
  const blob = new Blob(chunks, { type: mimeType });
  const path = `${state.user.id}/${Date.now()}.${ext}`;

  try {
    const { error: upErr } = await sb.storage
      .from(STORAGE_BUCKET)
      .upload(path, blob, { contentType: mimeType, upsert: false });

    /* BUG FIX #1 — Actionable error messages for storage failures */
    if (upErr) {
      if (upErr.message?.includes('Bucket not found') || upErr.statusCode === 400) {
        throw new Error(
          `Storage bucket "${STORAGE_BUCKET}" not found. ` +
          `Go to Supabase → Storage → New Bucket → name it "${STORAGE_BUCKET}" → set Public.`
        );
      }
      if (upErr.message?.includes('violates row-level security')) {
        throw new Error('Storage permission denied. Add an INSERT policy for authenticated users in Supabase → Storage → Policies.');
      }
      throw upErr;
    }

    const { data: urlData } = sb.storage.from(STORAGE_BUCKET).getPublicUrl(path);

    await sb.from('messages').insert([{
      conversation_id: state.activeConvId,
      sender_id:       state.user.id,
      sender_email:    state.user.email,
      content:         null,
      message_type:    'voice',
      voice_url:       urlData.publicUrl,
      voice_duration:  recSeconds,
    }]);

    await updateConvPreview(state.activeConvId, '🎙 Voice message');
  } catch(err) {
    showChatErr(err.message);
  }
}

/* ══════════════════════════════════════════════════════
   EMOJI PICKER
   Uses the <emoji-picker-element> web component which is
   already imported as an ES module at the top.
   ══════════════════════════════════════════════════════ */
function setupEmojiPicker() {
  const picker = document.getElementById('emoji-picker');
  picker.addEventListener('emoji-click', (e) => {
    const emoji = e.detail.unicode;
    // Insert emoji at cursor position in the text input
    const input = DOM.msgInput;
    const start = input.selectionStart;
    const end   = input.selectionEnd;
    input.value = input.value.slice(0, start) + emoji + input.value.slice(end);
    input.setSelectionRange(start + emoji.length, start + emoji.length);
    input.focus();
  });

  // Close picker when clicking outside
  document.addEventListener('click', (e) => {
    const wrap = document.getElementById('emoji-picker-wrap');
    if (!wrap.contains(e.target) && e.target.id !== 'emoji-btn' && !e.target.closest('#emoji-btn')) {
      wrap.classList.remove('open');
    }
  });
}

function toggleEmojiPicker() {
  document.getElementById('emoji-picker-wrap').classList.toggle('open');
}
function closeEmojiPicker() {
  document.getElementById('emoji-picker-wrap').classList.remove('open');
}

/* ══════════════════════════════════════════════════════
   NEW CONVERSATION (predictive search)
   ══════════════════════════════════════════════════════ */
function openNewChat()  { document.getElementById('new-chat-modal').classList.remove('hidden'); setTimeout(() => document.getElementById('user-search').focus(), 50); }
function closeNewChat() {
  document.getElementById('new-chat-modal').classList.add('hidden');
  document.getElementById('user-search').value = '';
  document.getElementById('user-results').innerHTML = '<p class="text-xs text-mist text-center py-4">Type to search for users</p>';
  document.getElementById('modal-error').classList.add('hidden');
}

let searchTimer = null;
async function searchUsers(query) {
  clearTimeout(searchTimer);
  const res     = document.getElementById('user-results');
  const spinner = document.getElementById('search-spinner');

  if (!query.trim()) {
    res.innerHTML = '<p class="text-xs text-mist text-center py-4">Type to search for users</p>';
    return;
  }

  /*
    FEATURE: Predictive / real-time search
    • oninput fires on every keystroke (vs onchange which only fires on blur)
    • Debounce 200ms for performance (reduced from 350ms for snappier feel)
    • Query uses `email.ilike('query%')` — starts-with match, not contains.
      Typing "a" returns all emails beginning with "a" immediately.
    • We also show online status in results.
  */
  searchTimer = setTimeout(async () => {
    spinner.classList.remove('hidden');
    res.innerHTML = '';

    try {
      const { data, error } = await sb
        .from('profiles')
        .select('id, email, last_seen')
        .ilike('email', `${query}%`)        // starts-with "query"
        .neq('id', state.user.id)
        .limit(12);

      if (error) throw error;
      spinner.classList.add('hidden');

      if (!data?.length) {
        res.innerHTML = '<p class="text-xs text-mist text-center py-4">No users found</p>';
        return;
      }

      data.forEach(user => {
        const isOnline  = user.last_seen && (Date.now() - new Date(user.last_seen).getTime()) < 90_000;
        const isBlocked = state.blockedUsers.has(user.id);
        const item = document.createElement('div');
        item.className = 'user-result flex items-center gap-3 px-3 py-2.5 rounded-xl';
        item.innerHTML = `
          <div class="relative flex-shrink-0">
            <div class="w-8 h-8 rounded-full bg-sage flex items-center justify-center text-paper text-xs font-medium">${initial(user.email)}</div>
            <span class="presence-dot ${isOnline ? 'online' : 'offline'} absolute -bottom-0.5 -right-0.5" data-presence-uid="${user.id}"></span>
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm text-ink truncate">${escHtml(user.email)}</p>
            <p style="font-size:.6rem;letter-spacing:.06em;text-transform:uppercase" class="${isOnline ? 'text-sage' : 'text-mist'}">${isOnline ? 'online' : 'offline'}</p>
          </div>
          ${isBlocked ? '<span style="font-size:.6rem;letter-spacing:.07em;text-transform:uppercase;color:#c84b31">blocked</span>' : ''}
        `;
        item.onclick = () => startConversation(user.id, user.email);
        res.appendChild(item);
      });
    } catch(err) {
      spinner.classList.add('hidden');
      res.innerHTML = '<p class="text-xs text-rust text-center py-4">Search failed</p>';
    }
  }, 200);
}

async function startConversation(otherId, otherEmail) {
  document.getElementById('modal-error').classList.add('hidden');
  try {
    const { data: existing } = await sb.from('conversations')
      .select('id')
      .or(`and(user1_id.eq.${state.user.id},user2_id.eq.${otherId}),and(user1_id.eq.${otherId},user2_id.eq.${state.user.id})`)
      .maybeSingle();

    let convId = existing?.id;
    if (!convId) {
      const { data: created, error } = await sb.from('conversations').insert([{
        user1_id: state.user.id, user1_email: state.user.email,
        user2_id: otherId,       user2_email: otherEmail,
      }]).select().single();
      if (error) throw error;
      convId = created.id;
    }

    closeNewChat();
    await loadConversations();
    await openConversation(convId, otherId, otherEmail);
  } catch(err) {
    const el = document.getElementById('modal-error');
    el.textContent = err.message || 'Could not start conversation.';
    el.classList.remove('hidden');
  }
}

/* ══════════════════════════════════════════════════════
   CONFIRM DIALOG (reusable)
   ══════════════════════════════════════════════════════ */
let confirmCallback = null;

function confirmDialog(text, onConfirm) {
  document.getElementById('confirm-text').textContent = text;
  confirmCallback = onConfirm;
  document.getElementById('confirm-modal').classList.remove('hidden');
}
function closeConfirm() {
  confirmCallback = null;
  document.getElementById('confirm-modal').classList.add('hidden');
}
document.getElementById('confirm-ok').onclick = async () => {
  if (confirmCallback) { await confirmCallback(); confirmCallback = null; }
  document.getElementById('confirm-modal').classList.add('hidden');
};

/* ══════════════════════════════════════════════════════
   MOBILE SIDEBAR
   ══════════════════════════════════════════════════════ */
function openSidebar() {
  document.getElementById('sidebar').classList.add('open');
  document.getElementById('sidebar-overlay').style.display = 'block';
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebar-overlay').style.display = 'none';
}

/* ══════════════════════════════════════════════════════
   UTILITY FUNCTIONS (DRY helpers)
   ══════════════════════════════════════════════════════ */
const initial      = email => (email || '?')[0].toUpperCase();
const escHtml      = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const formatDuration = secs => { const m=Math.floor(secs/60), s=secs%60; return `${m}:${String(s).padStart(2,'0')}`; };

function scrollBottom(smooth) {
  DOM.chatMessages.scrollTo({ top: DOM.chatMessages.scrollHeight, behavior: smooth ? 'smooth' : 'instant' });
}
function showChatErr(m) {
  document.getElementById('chat-error-text').textContent = m;
  document.getElementById('chat-error').classList.remove('hidden');
  setTimeout(() => document.getElementById('chat-error').classList.add('hidden'), 8000);
}

function cleanup() {
  clearInterval(presenceTimer);
  if (msgChannel) { sb.removeChannel(msgChannel); msgChannel = null; }
  state.conversations = [];
  state.activeConvId  = null;
  state.activePartner = null;
  state.onlineUsers   = new Set();
  state.blockedUsers  = new Set();
  state.unreadCounts  = {};
}

/* ══════════════════════════════════════════════════════
   KEYBOARD EVENTS
   ══════════════════════════════════════════════════════ */
DOM.msgInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    document.getElementById('message-form').requestSubmit();
  }
});

// Close emoji picker on Escape
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeEmojiPicker(); });
</script>
</body>
</html>